{% extends "main/main_base.html" %}

{% block title %}Comentarios{% endblock %}

{% block content %}
<div class="w-full min-h-screen font-[Inter]">
  <!-- Título -->
  <h1 class="text-3xl font-[Poor_Story] px-6 pt-6 text-black font-bold mb-6">COMENTARIOS DE {{ puesto.nombre.upper() }}</h1>

  <!-- Lista de comentarios dinámicos -->
  <div class="space-y-4 px-6">
    {% if comentarios %}
      {% for comentario in comentarios %}
        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg shadow-sm border-2 border-gray-200 w-full">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="font-bold">
                {{ comentario.usuario.nom_usuario }}
                {% if comentario.usuario_id == puesto.creador_id %}
                  <span class="ml-1 text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded">Creador</span>
                {% endif %}
              </span>
              <span>
                {% for i in range(comentario.calificacion or 0) %}⭐{% endfor %}
              </span>
            </div>
            <p>{{ comentario.comentario }}</p>
            {# Si tienes etiquetas, puedes mostrarlas aquí. #}
            {% if comentario.etiquetas %}
            <div class="flex gap-2 mt-2 flex-wrap">
              {% for tag in comentario.etiquetas %}
                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-sm">{{ tag.nombre }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% if user_is_creator %}
            <form method="POST" action="{{ url_for('eliminar_comentario', id=comentario.id, puesto_id=puesto.id) }}" class="ml-2">
              <button type="submit" class="text-red-600 hover:underline">Eliminar</button>
            </form>
          {% endif %}
          {% if session['user_id'] == comentario.usuario_id and not user_is_creator %}
            <a href="{{ url_for('editar_comentario', puesto_id=puesto.id, id=comentario.id) }}" class="ml-2" title="Editar">
              <img src="{{ url_for('static', filename='images/edit.svg') }}" class="h-6 w-6 inline-block align-middle" alt="Editar">
            </a>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div class="text-gray-500">Aún no hay comentarios.</div>
    {% endif %}
  </div>

  <!-- Formulario para agregar nuevo comentario (solo no creadores y si no ha comentado antes) -->
  {% set ya_comento = false %}
  {% if session['user_id'] and not user_is_creator %}
    {% for comentario in comentarios %}
      {% if comentario.usuario_id == session['user_id'] %}
        {% set ya_comento = true %}
      {% endif %}
    {% endfor %}
    {% if not ya_comento %}
      <form action="{{ url_for('nuevo_comentario', id=puesto.id) }}" method="POST" class="mt-6 flex flex-col gap-3 px-6">
        <textarea name="comentario" rows="4" placeholder="Escribe tu comentario..." 
          class="w-full p-3 border rounded-lg bg-white border-transparent focus:outline-none focus:ring-2 focus:ring-[#8EA604]" required></textarea>
        <select name="calificacion" required class="w-32">
          <option value="">Calificación</option>
          {% for i in range(1,6) %}
            <option value="{{ i }}">{{ i }} ⭐</option>
          {% endfor %}
        </select>
        <button type="submit" class="bg-yellow-400 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-500">
          Enviar comentario
        </button>
      </form>
    {% endif %}
  {% endif %}
</div>
{% endblock %}